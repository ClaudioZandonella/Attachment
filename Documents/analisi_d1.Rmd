---
title: "Analisi dei Cluster - Zandonella Callegher et al"
author: ''
date: "Maggio 2021"
output:
  word_document:
    toc: yes
    toc_depth: '3'
  html_notebook:
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
editor_options: 
  chunk_output_type: console
---


```{r,warning=FALSE}

rm(list=ls())
options(digits = 3)
```

Librerie 
```{r,warning=FALSE,include=TRUE}
library(car)
library(semPlot)
library(foreign)
library(lavaan)
library(psych)
library(effects)
library(sciplot)
library(psych)
```

```{r,include=FALSE}
# effect size
etas=function(m.lm){
  library(car)
  ris=NULL
  anovam=Anova(m.lm,type="III")
  l.SS=length(anovam$"Sum Sq")
  SStotal=sum(anovam$"Sum Sq"[2:l.SS])
  eta.q=(anovam$"Sum Sq"[2:(l.SS-1)])/SStotal
  peta.q=(anovam$"Sum Sq"[2:(l.SS-1)]) / ( (anovam$"Sum Sq"[2:(l.SS-1)]) + (anovam$"Sum Sq"[l.SS]))
  ris=data.frame(eta.q,peta.q)
  row.names(ris)=row.names(anovam)[2:(l.SS-1)]
  return(ris)
}
```

```{r,warning=FALSE,include=TRUE}
#######################################################################################
#                                                          #
setwd("~/Documents/Mega/Paper/In preparation/Zandonella et al/Analisi_data_d1")

load("/Users/tatiana/Documents/Mega/Paper/In preparation/Zandonella et al/Analisi_data_d1/ddef_datiECR.rda")

```



```{r}
ddef=ddef_datiECR[ddef_datiECR$age_year<12.30,]
ddef<- subset(ddef, ddef$fas !="NA")
nrow(ddef) #847
save(ddef,file=paste('ddef.rda',sep=""))
```

```{r,warning=FALSE}
load("/Users/tatiana/Documents/Mega/Paper/In preparation/Zandonella et al/Analisi_data_d1/ddef.rda")
```



```{r,warning=FALSE}
#######################################################################################
######################### DISTRIBUZIONE SDQ TOTALE
# 

#quantile(ddef$ebdtot_somma, prob = c(0.00, 0.30, 0.40, 0.70, 1), na.rm=TRUE)

#cut-off: 
#0-13 normale 
#borderline 14-16 
#problematico 17-40
ddef$SDQgroup <-ifelse(ddef$sdqtot_sum < 14, "1",
                       ifelse((ddef$sdqtot_sum >= 14) & (ddef$sdqtot_sum<=16),"2","3"))

prop.table(table(ddef$SDQgroup)) 

# pochi problemi!
```



```{r}
#se dovesse servire lavorare su dati primaria
primaria<-ddef[ddef$ordine_scolastico=="PRIMARIA",]
save(primaria,file=paste('primaria.rda',sep=""))
```



#Cluster mamma
```{r,warning=FALSE}
#######################################################################################
#1. ######################## CLUSTER
# 
dcM <- dist(ddef[,c(60:71)], method = "euclidean") # distance matrix
fit <- hclust(dcM, method="ward.D")
plot(fit, main = "Dendrogramma")
# dal dendrogramma sembrano emergere 4 cluster 
rect.hclust(fit, k=4, border="red")
ddef$gruppiattM <- as.factor(cutree(fit, k=4)) 

save(ddef,file=paste('ddef.rda',sep=""))

#######################################################
table(ddef$gruppiattM)
prop.table(table(ddef$gruppiattM))
prop.table(table(ddef$gruppiattM,ddef$genere),2) 
summary(table(ddef$gruppiattM,ddef$genere))
summary(table(ddef$gruppiattM,ddef$fas))

```

### Profilo grafico cluster
```{r}
fattore=rep(c("Ansia","Evitamento"),rep(dim(ddef)[1],2))
y=c(scale(ddef$Anxm),scale(ddef$Avm))
y1=c(ddef$Anxm,ddef$Avm)
gruppo=rep(ddef$gruppiattM,2)
dprof=data.frame(y,y1,fattore,gruppo)


dprof$nomi.gruppi=factor(dprof$gruppo,labels=c("Gruppo1: Sicuri (n = 231)","Gruppo 2: Ansiosi (n = 286)","Gruppo 3: Ansiosi-Evitanti (n = 100)","Gruppo 4: Evitanti (n = 230)"))



```

```{r}
par(mar=c(6, 5, 4, 2) + 0.1)

bargraph.CI(fattore, y, group = nomi.gruppi, data=dprof,legend=T,ylim=c(-2.4,1.6),x.leg=1.2, y.leg=-1.2,ylab="Punteggi standardizzati",xlab="",cex.lab=.8,cex.leg=.8, col=c("yellow","green","blue","red"))

save(ddef,file=paste('ddef.rda',sep=""))
```



### Valori medi per i 4 gruppi
```{r,warning=FALSE}
tapply(ddef$Anxm,ddef$gruppiattM,mean)
tapply(ddef$Avm,ddef$gruppiattM,mean)


tapply(ddef$Anxm,ddef$gruppiattM,sd)
tapply(ddef$Avm,ddef$gruppiattM,sd)
```


### Inferenza sui 4 gruppi rispetto a attaccamento mamma
```{r,warning=FALSE}
# mamma ansia
mod.anx=lm(Anxm~gruppiattM,ddef)
summary(mod.anx)
Anova(mod.anx) 
etas(mod.anx) 


# mamma evitamento
mod.av=lm(Avm~gruppiattM,ddef)
summary(mod.av)
Anova(mod.av) 
etas(mod.av)

```


### Prove su internalizing and externalizing 

```{r}
m1.1<-lm(externalizing~gruppiattM,ddef)
Anova(m1.1)
summary(m1.1)


g1<- effect("gruppiattM ", m1.1)
plot(g1,ylab="problemi", xlab="gruppi attaccamento mamma",main="",ci.stile="band",band.colors="red")

# R-squared basso. A livello descrittivo risultati interessanti e corrispondenti alle attese. Gruppo 3 (alta ansia, alto evitamento) maggiormente problematico


m1.2<-lm(externalizing~gruppiattM*genere+fas,ddef)
summary(m1.2)
Anova(m1.2)

g1.2<- effect("gruppiattM:genere ", m1.2)
plot(g1.2,ylab="problemi", xlab="gruppi attaccamento mamma",main="",ci.stile="band",band.colors="red")

#no interazione con genere 
```

```{r}
m2.1<-lm(internalizing~gruppiattM,ddef)
summary(m2.1)
Anova(m2.1)



g2.1<- effect("gruppiattM ", m2.1)
plot(g2.1,ylab="problemi", xlab="gruppi attaccamento mamma",main="",ci.stile="band",band.colors="red")

# R-squared basso. A livello descrittivo risultati interessanti e corrispondenti alle attese. Gruppo 3 (alta ansia, alto evitamento) maggiormente problematico


m2.2<-lm(internalizing~gruppiattM*genere,ddef)
summary(m2.2)
Anova(m2.2)



g2.2<- effect("gruppiattM:genere ", m2.2)
plot(g2.2,ylab="problemi", xlab="gruppi attaccamento mamma",main="",ci.stile="band",band.colors="red")

# no effetto genere ma a livello descrittivo risultati interessanti. vedere in particolare gruppo 3 femmine

```


#Cluster papà
```{r,warning=FALSE}
#######################################################################################
#1. ######################## CLUSTER
# 
dcP <- dist(ddef[,c(99:110)], method = "euclidean") # distance matrix
fit <- hclust(dcP, method="ward.D")
plot(fit, main = "Dendrogramma")
# dal dendrogramma sembrano emergere 4 cluster 
rect.hclust(fit, k=4, border="red")
ddef$gruppiattP <- as.factor(cutree(fit, k=4)) 

save(ddef,file=paste('ddef.rda',sep=""))


table(ddef$gruppiattP)
prop.table(table(ddef$gruppiattP))
prop.table(table(ddef$gruppiattP,ddef$genere),2) 
summary(table(ddef$gruppiattP,ddef$genere))
summary(table(ddef$gruppiattP,ddef$fas))

```

### Profilo grafico cluster
```{r}
fattore=rep(c("Ansia","Evitamento"),rep(dim(ddef)[1],2))
y=c(scale(ddef$Anxp),scale(ddef$Avp))
y1=c(ddef$Anxp,ddef$Avp)
gruppo=rep(ddef$gruppiattP,2)
dprof=data.frame(y,y1,fattore,gruppo)
```


### Valori medi per i 4 gruppi
```{r,warning=FALSE}
tapply(ddef$Anxp,ddef$gruppiattP,mean)
tapply(ddef$Avp,ddef$gruppiattP,mean)


tapply(ddef$Anxp,ddef$gruppiattP,sd)
tapply(ddef$Avp,ddef$gruppiattP,sd)
```

### Inferenza sui 4 gruppi rispetto a attaccamento papà
```{r,warning=FALSE}
# papà ansia
mod.anx=lm(Anxp~gruppiattP,ddef)
summary(mod.anx)
Anova(mod.anx) # 
etas(mod.anx) 


# papà evitamento
mod.av=lm(Avp~gruppiattP,ddef)
summary(mod.av)
Anova(mod.av) 
etas(mod.av)

```



```{r,warning=FALSE}

dprof$nomi.gruppi=factor(dprof$gruppo,labels=c("Gruppo1: Sicuri (n = 206)","Gruppo 2: Ansiosi (n = 230)","Gruppo 3: Evitanti (n = 311 )","Gruppo 4: Ansiosi-Evitanti (n = 100)"))


par(mar=c(6, 5, 4, 2) + 0.1)

bargraph.CI(fattore, y, group = nomi.gruppi, data=dprof,legend=T,ylim=c(-2.4,1.6),x.leg=1.2, y.leg=-1.2,ylab="Punteggi standardizzati",xlab="",cex.lab=.8,cex.leg=.8, col=c("yellow","green","blue","red"))
              
#N.B: nel gruppo 2 anche se nominati ansiosi i livelli sono comunque bassi              
box()

save(ddef,file=paste('ddef.rda',sep=""))
```


###Prove su internalizing e externalizing
```{r}
m3.1<-lm(externalizing~gruppiattP,ddef)
Anova(m3.1)
summary(m3.1)


g3.1<- effect("gruppiattP ", m3.1)
plot(g3.1,ylab="problemi esternalizzanti", xlab="gruppi attaccamento papà",main="",ci.stile="band",band.colors="red")

# R-squared bassissimo. A livello descrittivo  Gruppo 4 (alta ansia, alto evitamento) maggiormente problematico (come gruppo 3 mamma corrispondente a alta ansia alto evitamento)


m3.2<-lm(externalizing~gruppiattP*genere+fas,ddef)
summary(m3.2)
Anova(m3.2)

g3.2<- effect("gruppiattP:genere ", m3.2)
plot(g3.2,ylab="problemi esternalizzanti", xlab="gruppi attaccamento papà",main="",ci.stile="band",band.colors="red")

#no interazione con genere. In generale maschi più problemi esternalizzanti (risultati coerenti con la letteratura) 
```

```{r}
m4.1<-lm(internalizing~gruppiattP,ddef)
summary(m4.1)
Anova(m4.1)



g4.1<- effect("gruppiattP ", m4.1)
plot(g4.1,ylab="problemi", xlab="gruppi attaccamento papà",main="",ci.stile="band",band.colors="red")

# R-squared bassissimo. A livello descrittivo risultati interessanti e corrispondenti alle attese. Gruppo 4 (alta ansia, alto evitamento) maggiormente problematico


m4.2<-lm(internalizing~gruppiattP*genere,ddef)
summary(m4.2)
Anova(m4.2)



g4.2<- effect("gruppiattP:genere ", m4.2)
plot(g4.2,ylab="problemi", xlab="gruppi attaccamento papà",main="",ci.stile="band",band.colors="red")

# no effetto genere ma a livello descrittivo risultati interessanti. 

```

Note label gruppi:

Gruoo1 mamma = Gruppo 1 papà = sicuri

Gruoo2 mamma = Gruppo 2 papà = ansiosi

Gruoo3 mamma = Gruppo 4 papà = ansiosi-evitanti

Gruoo4 mamma = Gruppo 3 papà = evitanti

     
